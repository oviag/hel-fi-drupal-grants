<?php

/**
 * @file
 * Provides an example of a webform handler.
 */

use Drupal\block_content\Entity\BlockContent;
use Drupal\Component\Utility\NestedArray;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Datetime\DrupalDateTime;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Link;
use Drupal\Core\Render\Markup;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Url;
use Drupal\grants_attachments\AttachmentHandler;
use Drupal\grants_handler\ApplicationHandler;
use Drupal\grants_handler\Event\UserLogoutEvent;
use Drupal\grants_handler\EventsService;
use Drupal\grants_handler\Form\CopyApplicationModalForm;
use Drupal\grants_handler\Plugin\WebformElement\CompensationsComposite;
use Drupal\grants_handler\Processor\NumberProcessor;
use Drupal\webform\Entity\Webform;
use Drupal\webform\WebformInterface;
use Drupal\webform\WebformSubmissionStorageInterface;
use GuzzleHttp\Exception\GuzzleException;
use Symfony\Cmf\Component\Routing\RouteObjectInterface;

/**
 * Implements hook_theme().
 */
function grants_handler_theme(): array {
  return [
    'webform_handler_grants_summary' => [
      'variables' => ['settings' => NULL, 'handler' => []],
    ],

    'webform_submission_messages' => [
      'variables' => [
        'messages' => NULL,
        'message_form' => NULL,
        'submission' => NULL,
      ],
    ],

    'webform_submission_message_attachments' => [
      'variables' => [
        'attachments_to_print' => NULL,
        'attachments' => NULL,
      ],
    ],

    'webform_submission_events' => [
      'variables' => [
        'submission' => NULL,
      ],
    ],

    'webform_submission_handler_details' => [
      'variables' => [
        'submission' => NULL,
      ],
    ],

    'webform_submission_attachment_list' => [
      'variables' => [
        'submission' => NULL,
      ],
    ],

    'webform_submission_status_history' => [
      'variables' => [
        'submission' => NULL,
      ],
    ],

    'grants_handler_completion' => [
      'variables' => [
        'submissionId' => NULL,
        'submissionObject' => NULL,
      ],
    ],

    'grants_handler_view_application' => [
      'variables' => [
        'submissionId' => NULL,
        'submissionObject' => NULL,
      ],
    ],

    'grants_handler_edit_application' => [
      'variables' => [
        'submissionId' => NULL,
        'submissionObject' => NULL,
        'editForm' => NULL,
      ],
    ],

    // Override the webform progress bar so we can add our page classes.
    'webform_progress_bar' => [
      'variables' => [
        'webform' => NULL,
        'webform_submission' => NULL,
        'current_page' => NULL,
        'operation' => NULL,
        'max_pages' => 10,
        'page_classes' => [],
      ],
    ],

    // Override the webform progress tracker so we can add our page classes.
    'webform_progress_tracker' => [
      'variables' => [
        'webform' => NULL,
        'webform_submission' => NULL,
        'current_page' => NULL,
        'operation' => NULL,
        'max_pages' => 10,
        'page_classes' => [],
      ],
    ],

    'application_list' => [
      'variables' => [
        'items' => NULL,
        'type' => NULL,
        'header' => NULL,
        'id' => NULL,
        'description' => NULL,
      ],
    ],

    'application_list_item' => [
      'variables' => [
        'submission' => NULL,
        'document' => NULL,
      ],
    ],

    'application_status_tag' => [
      'variables' => [
        'applicationID' => NULL,
        'langcode' => NULL,
      ],
    ],

    'message_list' => [
      'variables' => [
        'items' => NULL,
        'style' => NULL,
      ],
    ],

    'message_list_item' => [
      'variables' => [
        'message' => NULL,
      ],
    ],

    'message_notification_item' => [
      'variables' => [
        'message' => NULL,
      ],
    ],

    'submission_for_modal_form' => [
      'variables' => [
        'submission_id' => NULL,
        'submission' => NULL,
      ],
    ],

    'application_copy_modal_form' => [
      'render element' => 'form',
      'template' => 'grants-handler-copy-application-modal',
    ],

    'profile_data_icon' => [
      'variables' => [
        'text_value' => NULL,
        'class' => NULL,
      ],
    ],

    'hds_notification' => [
      'variables' => [
        'type' => NULL,
        'label' => NULL,
        'body' => NULL,
        'class' => NULL,
      ],
    ],

    'grants_handler_print_atv_document' => [
      'variables' => [
        'atv_document' => NULL,
        'pages' => NULL,
        'document_langcode' => NULL,
      ],
      'template' => 'grants-handler-print-atv-document',
    ],
    'community_officials_composite' => [
      'render element' => 'element',
    ],
    'bank_account_composite' => [
      'render element' => 'element',
    ],
    'community_address_composite' => [
      'render element' => 'element',
    ],
    'grants_service_page_block' => [
      'render element' => 'build',
      'variables' => [
        'link' => NULL,
        'text' => NULL,
        'auth' => NULL,
      ],
    ],
    'application_timeout_message' => [
      'variables' => [
        'message_heading' => NULL,
        'message_body' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_entity_type_alter().
 */
function grants_handler_entity_type_alter(array &$entity_types): void {
  // Add our custom handler for webform.
  $entity_types['webform_submission']->setStorageClass('Drupal\grants_handler\GrantsHandlerSubmissionStorage');
}

/**
 * Path to the new form alert javascripts.
 */
function grants_handler_js_alter(&$javascript) {
  $key = \Drupal::service('extension.list.module')
    ->getPath('webform') . '/js/webform.form.unsaved.js';
  if (isset($javascript[$key])) {
    $javascript[$key]['data'] = \Drupal::service('extension.list.module')
      ->getPath('grants_handler') . '/js/webform.form.unsaved.js';
  }
}

/**
 * Adds webform details to the printing page.
 */
function grants_handler_preprocess_print_atv_document(&$vars) {
  $wf = $vars['webform_submission']->getWebform();
  $vars["title"] = $wf->label();
  $vars['helsinki_logo'] = [
    '#theme' => 'misc/helsinki_logo_icon',
    '#language' => $vars['document_langcode'],
  ];
}

/**
 * {@inheritdoc}
 */
function grants_handler_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'grants_handler/application-status-check';

  // Get baseurl.
  $base_url = \Drupal::request()->getSchemeAndHttpHost();

  // Get current language.
  $currentLanguage = Drupal::languageManager()->getCurrentLanguage();

  // Set url to variable.
  $attachments['#attached']['drupalSettings']['grants_handler']['site_url'] = $base_url . '/' . $currentLanguage->getId() . '/';

}

/**
 * Handles compensation element special configurations.
 *
 * @param array $element
 *   Element array.
 */
function _grants_handler_handle_compensation_element(&$element) {
  $tOpts = ['context' => 'Grant Print View Boolean'];

  $oneSubventionPerElement = $element['#onlyOneSubventionPerApplication'] ?? FALSE;
  $includeLibrary = FALSE;

  if ($oneSubventionPerElement) {
    $element['#wrapper_attributes']['data-single-subvention-type'] = $oneSubventionPerElement;
    $includeLibrary = TRUE;
  }

  // These could come from a service, but now only starttiavustus is used.
  if (array_search('31', $element['#subventionType']) !== FALSE) {
    $element['#wrapper_attributes']['data-question-subtype-id'] = '31';
    $element['#wrapper_attributes']['data-question-subvention-input-value'] = '500,00â‚¬';
    $element['#wrapper_attributes']['data-question-subvention-strings'] = json_encode([
      'question_text' => t('Are you applying for a start grant?'),
      'yes' => t('Yes', [], $tOpts),
      'no' => t('No', [], $tOpts),
    ]);

    $includeLibrary = TRUE;
  }

  // Enable for specific subvention type.
  if (array_search('42', $element['#subventionType']) !== FALSE) {
    $element['#wrapper_attributes']['data-limited-subvention'] = '42';
    $includeLibrary = TRUE;
  }

  if ($includeLibrary) {
    $element['#attached']['library'][] = 'grants_handler/compensation-element';
  }
}

/**
 * Alter webform elements.
 *
 * @param array $element
 *   Webform specific element properties include:
 *   - #webform: The element's parent webform ID.
 *   - #webform_submission: The element's related webform submission ID.
 *   - #webform_id: The element's unique webform key.
 *   - #webform_key: The element's webform key/name.
 *   - #webform_parent_key: The element's parent key/name.
 *   - #webform_parent_flexbox: TRUE if the element's parent is a
 *     flexbox container.
 *   - #webform_depth: The depth level of the element in the form's
 *     tree hierarchy.
 *   - #webform_children: An array of child element keys/names.
 *   - #webform_multiple: TRUE if element stores multiple values.
 *   - #webform_composite: TRUE if element stores composite values.
 *   - #webform_parents: An array containing the element's parent keys/names.
 *
 *   Webform specific composite sub-element properties include:
 *   - #webform_composite_id: The composite sub-element's ID.
 *   - #webform_composite_key: The composite sub-element's parent key and
 *     element key.
 *   - #webform_composite_parent_key: The composite sub-element's parent key.
 *
 *   Sub-element's can have properties defined using #SUB_ELEMENT__PROPERTY.
 *   For example, an other element's placeholder can be defined using
 *   the #other__placeholder property.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The current state of the form.
 * @param array $context
 *   An associative array containing the following key-value pairs:
 *   - form: The form structure to which elements is being attached.
 *
 * @see \Drupal\webform\WebformSubmissionForm::prepareElements()
 * @see hook_webform_element_ELEMENT_TYPE_alter()
 */
function grants_handler_webform_element_alter(array &$element, FormStateInterface $form_state, array $context) {

  $user = Drupal::currentUser();
  $roles = $user->getRoles();

  if (!in_array('helsinkiprofiili', $roles)) {
    return;
  }

  // Code here acts on all elements included in a webform.
  /** @var \Drupal\webform\WebformSubmissionForm $form_object */
  $form_object = $form_state->getFormObject();
  if ($element['#type'] == 'webform_multiple') {
    if (isset($element['#multiple__header']) && $element['#multiple__header'] === TRUE) {
      $element['#wrapper_attributes']['class'][] = 'table-layout-form';
    }
    else {
      $element['#wrapper_attributes']['class'][] = 'hidden-head';
    }
    if ($element['#webform_plugin_id'] === 'grants_compensations') {
      _grants_handler_handle_compensation_element($element);
    }
  }
  if (get_class($form_object) == 'Drupal\webform\WebformSubmissionForm') {
    /** @var \Drupal\webform\WebformSubmissionInterface $webform_submission */
    $webformSubmission = $form_object->getEntity();

    // Get data from webform.
    $webformData = $webformSubmission->getData();

    // For some reason, this is only place I've found to do this.
    if (isset($element['#webform_key']) && $element['#webform_key'] == 'subventions') {
      // Get form values.
      $requiredSubvention = $element['#requiredSubventionType'] ?? '';
      $formValues = $form_state->getValues();
      // Get names from composite.
      $typeNames = CompensationsComposite::getOptionsForTypes();
      // Get subvention types from settings form.
      $subventionTypes = $element['#subventionType'];
      // Set element cardinality to match whatever is selected in.
      $element['#cardinality'] = $subventionTypes ? count($subventionTypes) : -1;

      $defaultValues = [];
      // Get items either from form values or from loaded data.
      $inputItems = ($formValues["subventions"] ?? isset($webformData['subventions'])) ? $webformData['subventions'] : [];
      foreach ($subventionTypes as $id => $typeId) {
        $required = $typeId === $requiredSubvention;
        $itemFound = 'notfound';
        // If this item is not already been added to user input array.
        foreach ($inputItems as $sKey => $sItem) {
          if ($sItem['subventionType'] == (string) $id) {
            $itemFound = $sKey;
          }
        }
        // Then we set default values to contain type id + name.
        if ($itemFound == 'notfound') {
          $defaultValues[] = [
            'subventionTypeTitle' => $typeNames[$typeId] . ($required ? '*' : ''),
            'subventionType' => $typeId,
          ];
        }
        // But if we have either form data or saved data, let's use that.
        else {
          if (isset($inputItems[$itemFound])) {
            $value = $inputItems[$itemFound];
            $value['subventionTypeTitle'] = $typeNames[$typeId] . ($required ? '*' : '');
            $defaultValues[] = $value;
          }
        }
      }
      // SET values.
      $element['#default_value'] = $defaultValues;
    }

    if (
      isset($webformData['status']) &&
      !ApplicationHandler::isSubmissionEditable(NULL, $webformData['status']) &&
      $element['#type'] != 'webform_actions') {
      $element['#disabled'] = TRUE;
    }
    else {
      if (!isset($webformData['status'])) {
        if (isset($element['#webform_key']) && $element['#webform_key'] == 'status') {
          $element['#default_value'] = 'DRAFT';
        }
      }
    }

    // Hacky fix for issues with camelCase keys with Custom component keys.
    // Set issuerName value to issuer_name field and unset camelCase.
    if (isset($element['#webform_key']) && ($element['#webform_key'] == 'myonnetty_avustus' || $element['#webform_key'] == 'haettu_avustus_tieto')) {
      $newValues = [];
      if (isset($element["#default_value"])) {
        foreach ($element["#default_value"] as $default) {
          $new = $default;
          if (isset($default['issuerName'])) {
            $new['issuer_name'] = $default['issuerName'];
            unset($new['issuerName']);
          }
          $newValues[] = $new;
        }
      }
      $element["#default_value"] = $newValues;
    }

    // For some reason this selection cannot be done in address composite class.
    // so we'll need to hack this here.
    // @todo Can the composite default value be added here?
    if (isset($element['#webform_key']) && ($element['#webform_key'] == 'community_address')) {

      /** @var \Drupal\grants_profile\GrantsProfileService $grantsProfileService */
      $grantsProfileService = \Drupal::service('grants_profile.service');
      $applicantType = $grantsProfileService->getApplicantType();

      $selectedCompany = $grantsProfileService->getSelectedRoleData();
      try {
        $profileData = $grantsProfileService->getGrantsProfileContent($selectedCompany ?? '');
      }
      catch (GuzzleException $e) {
      }

      if ($selectedCompany["type"] != 'private_person' && isset($element['#default_value']) && $element['#default_value']) {
        $formValues = $element['#default_value'];

        if (isset($formValues['community_street'])) {
          $formSelection = $formValues['community_street'] . ', ' .
            $formValues['community_post_code'] . ', ' .
            $formValues['community_city'];
        }
        else {
          $formSelection = '';
        }

        // Set initial defaultvalue to false to avoid unwanted selections
        // in unfilled form.
        $defaultDelta = FALSE;

        // Loop addresses to figure out which address is actually selected.
        foreach ($profileData['addresses'] as $delta => $address) {
          $deltaString = $address["address_id"];
          $optionSelection = $address['street'] . ', ' . $address['postCode'] .
            ', ' . $address['city'];

          // If this value is same than the one on form, then set default value.
          if ($formSelection == $optionSelection) {
            $defaultDelta = $deltaString;
          }
        }
        if ($defaultDelta) {
          $element["#default_value"]["community_address_select"] = $defaultDelta;
        }
      }
    }

    // For some reason this selection cannot be done in official
    // composite class.
    // so we'll need to hack this here.
    // @todo Can the composite default value be added here?
    if (
      isset($element['#webform_key']) &&
      $element['#webform_key'] == 'community_officials') {

      /** @var \Drupal\grants_profile\GrantsProfileService $grantsProfileService */
      $grantsProfileService = \Drupal::service('grants_profile.service');

      $selectedCompany = $grantsProfileService->getSelectedRoleData();
      $profileData = $grantsProfileService->getGrantsProfileContent($selectedCompany ?? '');

      $defaultDelta = '0';

      if (isset($element['#default_value'])) {
        foreach ($element['#default_value'] as $delta => $official) {
          $valueName = $official['name'];

          foreach ($profileData['officials'] as $profileDelta => $profileOfficial) {
            $deltaString = (string) $profileDelta;

            if ($valueName == $profileOfficial['name']) {
              $defaultDelta = $deltaString;
            }
          }
          $element['#default_value'][$delta]['community_officials_select'] = $defaultDelta;
        }
      }
    }
  }
}

/**
 * Handle text value for the description fields.
 *
 * @param string|array $textValue
 *   String or array containing text values.
 *
 * @return array
 *   Returns render array.
 */
function _grants_handler_add_checkmark_to_text(string|array $textValue): array {
  $description = is_array($textValue)
    ? implode(', ', $textValue)
    : $textValue;

  return [
    '#theme' => 'profile_data_icon',
    '#text_value' => $description,
    '#class' => 'hel-icon--size-s',
  ];
}

/**
 * Add icons to some.
 *
 * @param mixed $array
 *   Array being manipulated.
 * @param mixed $value
 *   Imported value for the array.
 * @param bool $show_checkmark
 *   Is the checkmark visible.
 */
function _grants_handler_imported_handler(
  mixed &$array,
  mixed $value,
  bool $show_checkmark = TRUE) {

  if (!is_array($array)) {
    return;
  }

  $array["#value"] = $value;
  $array['#attributes'] = ['readonly' => 'readonly', 'style' => 'display:none'];
  if ($value) {
    $array['#description'] = $show_checkmark ? _grants_handler_add_checkmark_to_text($value) : $value;
  }

  $array['#wrapper_attributes']['class'][] = 'grants-handler--prefilled-field';
}

/**
 * Missing data prints.
 *
 * @param array|null $element
 *   The element in question.
 * @param string $str1
 *   Header of the alert notification.
 * @param string $str2
 *   Link text.
 * @param string $str3
 *   Clarifying text.
 *
 * @todo Must be fixed with proper template & things.
 */
function _grants_handler_missing_data(
  ?array &$element,
  string $str1 = 'Field is missing.',
  string $str2 = 'Go to grants profile',
  string $str3 = 'to fill out missing data.'): void {

  if (is_null($element)) {
    return;
  }

  unset($element['#value']);
  unset($element['#default_value']);
  $element['#required'] = TRUE;
  $element['#attributes'] = [
    'required' => 'required',
    'readonly' => 'readonly',
    'style' => 'display:none',
  ];
  $element['#description'] = [
    '#theme' => 'hds_notification',
    '#type' => 'alert',
    '#class' => '',
    '#label' => $str1,
    '#body' => Link::createFromRoute($str2, 'grants_profile.show')
      ->toString() . ' ' . $str3,
  ];
}

/**
 * Recursively alter number fields to allow decimals and commas.
 */
function _grants_handler_alter_number_fields(&$element) {
  if (is_array($element)) {
    // Check if the element is a number field.
    if (isset($element['#type']) && $element['#type'] === 'number') {
      $element['#process'][] = [
        NumberProcessor::class, 'process',
      ];
    }

    // Recursively traverse the sub-elements.
    foreach ($element as &$sub_element) {
      _grants_handler_alter_number_fields($sub_element);
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function grants_handler_webform_submission_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  $user = \Drupal::currentUser();
  $roles = $user->getRoles();

  if (!in_array('helsinkiprofiili', $roles)) {
    return;
  }

  $form['actions']['wizard_next']['#validate'][] = '::noValidate';

  _grants_handler_alter_number_fields($form);

  $grants_formnavigation_helper = \Drupal::service('grants_handler.navigation_helper');
  if (isset($form['#webform_submission']) && $form['#webform_submission']) {
    $all_errors = $grants_formnavigation_helper->getAllErrors($form['#webform_submission']);
  }

  if (isset($form['pages'])) {
    foreach ($form['pages'] as $key => $value) {
      if (!strstr($key, '#')) {
        $exploded_title = explode("'", $form['pages'][$key]['#attributes']['title']);
        if (isset($exploded_title[1])) {
          $stripped_title = $exploded_title[1];
          if (isset($stripped_title) && strlen($stripped_title) > 0) {
            $form['pages'][$key]['#attributes']['title'] = $stripped_title;
            if ((isset($all_errors[$key]) && !empty($all_errors[$key]))) {
              // Add an info to the title if there are errors.
              $form['pages'][$key]['#attributes']['title'] .= ' (' . t('Errors', [], ['context' => 'Webform wizard page status messages']) . ')';
            }
            $hasVisitedThisPage = $grants_formnavigation_helper->hasVisitedPage(
              $form['#webform_submission'],
              $key
            );
            if (is_array($all_errors) && $hasVisitedThisPage && isset($all_errors[$key]) && empty($all_errors[$key])) {
              // Add an info to the title if the page is complete.
              $form['pages'][$key]['#attributes']['title'] .= ' (' . t('Completed', [], ['context' => 'Webform wizard page status messages']) . ')';
            }

          }
        }
      }
    }
  }

  /** @var \Drupal\grants_profile\GrantsProfileService $grantsProfileService */
  $grantsProfileService = \Drupal::service('grants_profile.service');
  $selectedCompany = $grantsProfileService->getSelectedRoleData();

  /** @var \Drupal\webform\Entity\WebformSubmission $webform_submission */
  $webform_submission = $form_state->getFormObject()->getEntity();
  $formData = $webform_submission->getData();

  $webform = $webform_submission->getWebform();
  $isClosed = $webform->isClosed();

  $form['#attached']['library'][] = 'grants_handler/webform-additions';

  if ($selectedCompany != NULL) {

    if (
      isset($form["elements"]["1_hakijan_tiedot"]["status"]["#default_value"]) &&
      !ApplicationHandler::isSubmissionEditable(NULL, $form["elements"]["1_hakijan_tiedot"]["status"]["#default_value"])
    ) {
      $form["actions"]["submit"]['#disabled'] = TRUE;
    }

    $grantsProfile = $grantsProfileService->getGrantsProfileContent($selectedCompany);

    // Pass variable to Drupal.Settings.
    $form['#attached']['drupalSettings']['grants_handler']['grantsProfile'] = $grantsProfile;
    $form['#attached']['drupalSettings']['grants_handler']['selectedCompany'] = $selectedCompany;
    $form['#attached']['drupalSettings']['grants_handler']['formData'] = $formData;
    $form['#attached']['drupalSettings']['grants_handler']['submissionId'] = $formData["application_number"] ?? '';

    $lockService = \Drupal::service('grants_handler.form_lock_service');
    $lockedStatus = FALSE;
    if (!empty($formData["application_number"])) {
      $lockedStatus = $lockService->isApplicationFormLocked($formData["application_number"]);
    }

    $form['#attached']['drupalSettings']['grants_handler']['formLocked'] = $lockedStatus;

    if (isset($form["elements"]["1_hakijan_tiedot"]["tilinumero"]["account_number"]["#default_value"])) {
      $form["elements"]["1_hakijan_tiedot"]["tilinumero"]["account_number_select"]["#default_value"] = $form["elements"]["1_hakijan_tiedot"]["tilinumero"]["account_number"]["#default_value"];
    }

    foreach ($form['elements'] as $page_name => $page_contents) {
      $page_prefetched = FALSE;
      $page_required = FALSE;
      if ($page_contents['#type'] === 'container') {
        foreach ($form['elements'][$page_name] as $section_key => $section_contents) {
          if (!strstr($section_key, '#') && is_array($section_contents)) {
            foreach ($section_contents as $element_key => $element_contents) {
              if (!strstr($element_key, '#') && is_array($element_contents)) {
                if (array_key_exists('#required', $element_contents) && $element_contents['#required'] === TRUE) {
                  $page_required = TRUE;
                }
                if (array_key_exists('#type', $element_contents) &&
                  ($element_contents['#type'] === 'community_address_composite' ||
                    $element_contents['#type'] === 'community_officials_composite' ||
                    $element_contents['#type'] === 'bank_account_composite' ||
                    $element_key === 'community_purpose'
                  )
                ) {
                  $page_prefetched = TRUE;
                }
                if ($page_required && $page_prefetched) {
                  break 2;
                }
              }
            }
          }
        }

        $infoelement = [
          'omat_tiedot_page_infobox_' . $page_name => [
            '#theme' => 'hds_notification',
            '#type' => 'notification',
            '#class' => '',
            '#label' => t('Some information fetched from personal information'),
            '#body' => t('Check the information on the form before sending the application. You can change your own information from personal information section of the site.'),
          ],
        ];
        $required_fields_info_element = [
          'required_fields_infobox' . $page_name =>
            [
              '#theme' => 'hds_notification',
              '#type' => 'notification',
              '#label' => t('Fill in the fields to all the questions that you can answer.'),
              '#body' => t('Fields marked with * are mandatory information that you must fill in in order to save and send the information.'),
              '#class' => 'notification-margin-bottom',
            ],
        ];
        $page_title_element = [];
        $page_title_element['#title'] = $page_contents['#title'];
        $page_title_element['#type'] = $page_contents['#type'];

        $page_title_element['page_title'] = [
          '#type' => 'markup',
          '#title' => 'title',
          '#markup' => preg_replace("~^.*\. ~", '', $page_contents['#title']),
          '#prefix' => '<h2 class="grants__page-header">',
          '#suffix' => '</h2>',
        ];

        // Drupal wants things in a order when returning from an AJAX call.
        // These are re-merged to the array below.
        unset($page_contents['#title']);
        unset($page_contents['#type']);

        if (!$isClosed) {
          $form['elements'][$page_name] = array_merge($required_fields_info_element, $form['elements'][$page_name]);
        }
        if (!$isClosed && $page_prefetched) {
          $form['elements'][$page_name] = array_merge($infoelement, $form['elements'][$page_name]);
        }
        $form['elements'][$page_name] = array_merge($page_title_element, $form['elements'][$page_name]);
      }
    }

    if (!$isClosed && array_key_exists('1_hakijan_tiedot', $form['elements']) && is_array($form['elements']['1_hakijan_tiedot'])) {

      if (isset($grantsProfile["companyName"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]["community_official_name"], $grantsProfile["companyName"]);
      }
      if (isset($grantsProfile["companyNameShort"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteison_lyhenne"]["community_official_name_short"], $grantsProfile["companyNameShort"], FALSE);
      }

      if (isset($grantsProfile["registrationDate"]) && $grantsProfile["registrationDate"] !== '') {
        $regDate = new DrupalDateTime($grantsProfile["registrationDate"], 'Europe/Helsinki');
        $regDate = $regDate->format('d.m.Y');
      }
      else {
        $regDate = t('Unknown', [], ['context' => 'Unset Profile Fields']);
      }

      if (isset($grantsProfile["companyHome"]) && $grantsProfile["companyHome"] !== '') {
        $companyHome = $grantsProfile["companyHome"];
      }
      else {
        $regDate = t('Unknown', [], ['context' => 'Unset Profile Fields']);
      }
      _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]['grants_profile__items_container']["registration_date"], $regDate);
      _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]['grants_profile__items_container']["company_number"], $selectedCompany['identifier']);

      if (isset($grantsProfile["foundingYear"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["perustamisvuosi"]["founding_year"], $grantsProfile["foundingYear"], FALSE);
      }

      if (isset($companyHome)) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]['grants_profile__items_container']["home"], $companyHome);
      }

      if (isset($grantsProfile["companyStatus"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]['grants_profile__items_container']["community_status"], $grantsProfile["companyStatus"]);
      }

      if (isset($grantsProfile["companyStatusSpecial"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["yhteiso_jolle_haetaan_avustusta"]['grants_profile__items_container']["community_status_special"], $grantsProfile["companyStatusSpecial"]);
      }

      if (isset($grantsProfile["companyHomePage"])) {
        _grants_handler_imported_handler($form["elements"]["1_hakijan_tiedot"]["verkkosivut"]["homepage"], $grantsProfile["companyHomePage"], FALSE);
      }

    }

  }
  else {
    \Drupal::messenger()
      ->addError(t("You don't have company selected, no fields are prepopulated"));
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_webform_submission_data(&$variables) {

  // Create query + type condition.
  $query = \Drupal::entityQuery('block_content')
    ->condition('type', 'terms_block');

  $language = \Drupal::languageManager()->getCurrentLanguage();
  $variables['preview_title'] = $variables['webform']->getSetting('preview_title');

  // Get blocks for ALL forms and this form.
  $orGroup = $query
    ->orConditionGroup()
    ->condition('field_form', $variables['webform']->id())
    ->condition('field_show_on_all_forms', TRUE);
  $query->condition($orGroup);
  $results = $query->execute();

  // Load blocks.
  $blocks = BlockContent::loadMultiple(array_values($results));
  // Add term acceptance things for every block loaded.
  foreach ($blocks as $block) {
    // Render content.
    // See admin/structure/block/block-content/manage/terms_block/display.
    // Only body field is wanted to render.
    $output = \Drupal::entityTypeManager()
      ->getViewBuilder('block_content')
      ->view($block);

    // We use title field directly so we need to get translated version.
    $translatedBlock = $block->getTranslation($language->getId());
    $translatedTitle = $translatedBlock->get('field_link_title')->value;

    // Content rendering respects active language.
    $render = \Drupal::service('renderer')->render($output);
    // Id for element.
    $htmlId = 'accept_terms_' . $block->id();
    $terms_info = [
      '#theme' => 'hds_notification',
      '#type' => 'alert',
      '#label' => t('Note!'),
      '#body' => t('Accept the terms and send the application.'),
      '#class' => 'notification-margin-bottom',
    ];
    $terms_info_rendered = Markup::create(render($terms_info));
    // Add html for checkbox.
    $variables['confirm_texts'][] = '<div class="terms_block">' . $render . '</div>
      ' . $terms_info_rendered . '
      <div class="hds-checkbox">
        <input type="checkbox" id="' . $htmlId . '" required="required" class="hds-checkbox__input" />
        <label for="' . $htmlId . '"  class="hds-checkbox__label">' . $translatedTitle . '</label>
      </div>';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_webform_submission(&$variables) {
  // Get submission object.
  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables['webform_submission'];
  $webform = $submission->getWebform();
  $data = $submission->getData();
  if (isset($data["application_number"])) {
    $variables['applicationNumber'] = $data["application_number"];
  }
  if (isset($data["business_purpose"])) {
    $variables["elements"]["data"]["3_yhteison_tiedot"]["#element"]["business_info"]["business_purpose"] = $data["business_purpose"];
  }

  // Parse messages.
  $variables['messages'] = [
    '#theme' => 'webform_submission_messages',
    '#submission' => $submission,
  ];

  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  $variables['statusTag'] = [
    '#theme' => 'application_status_tag',
    '#applicationID' => $data["application_number"],
    '#langcode' => $language,
  ];

  // Parse history.
  $variables['history'] = [
    '#theme' => 'webform_submission_status_history',
    '#submission' => $submission,
  ];
  if (ApplicationHandler::isSubmissionEditable($submission)) {
    $urlCustom = Url::fromRoute(
      'grants_handler.edit_application',
      [
        'webform' => $webform->id(),
        'webform_submission' => $submission->id(),
      ],
      [
        'attributes' => [
          'data-drupal-selector' => 'application-edit-link',
        ],
      ]
    );
    $variables['editSubmissionUrlCustom'] = $urlCustom;
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_grants_handler_webform_print_submission(&$variables) {
  // Get submission object.
  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables['webform_submission'];
  $webform = $submission->getWebform();
  $data = $submission->getData();
  if (isset($data["application_number"])) {
    $variables['applicationNumber'] = $data["application_number"];
  }
  if (isset($data["business_purpose"])) {
    $variables["elements"]["data"]["3_yhteison_tiedot"]["#element"]["business_info"]["business_purpose"] = $data["business_purpose"];
  }

  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  $variables['statusTag'] = [
    '#theme' => 'application_status_tag',
    '#langcode' => $language,
    '#applicationID' => $data["application_number"],
  ];

  // Parse history.
  $variables['history'] = [
    '#theme' => 'webform_submission_status_history',
    '#submission' => $submission,
  ];
  $variables['webform'] = $webform;

  // Information.
  $variables['information'] = [
    '#theme' => 'webform_submission_information',
    '#webform_submission' => $submission,
    '#source_entity' => $submission,
  ];

  $page = \Drupal::service('entity_type.manager')
    ->getViewBuilder($submission->getEntityTypeId())
    ->view($submission, 'default');

  // Submission.
  $variables['submission'] = $page;
}

/**
 * Add messages to webform submission view.
 *
 * @throws \Exception
 */
function grants_handler_preprocess_webform_submission_messages(&$variables) {

  $submission = $variables['submission'];
  $submissionData = $submission->getData();

  /** @var \Drupal\grants_handler\ApplicationHandler $applicationHandler */

  $messages = [];
  if (isset($submissionData['messages']) && is_array($submissionData['messages'])) {
    foreach ($submissionData['messages'] as $message) {
      $messages[] = [
        '#theme' => 'message_list_item',
        '#message' => $message,
      ];
    }
  }
  $variables['messages'] = [
    '#theme' => 'message_list',
    '#items' => $messages,
    '#style' => 'default',
  ];

  // If submission is ok for messaging.
  if (ApplicationHandler::isSubmissionMessageable($submission, NULL)) {
    // Add message form.
    $variables['message_form'] = \Drupal::formBuilder()
      ->getForm('Drupal\grants_handler\Form\MessageForm', $submission);
  }
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * @throws \Exception
 */
function grants_handler_preprocess_webform_submission_status_history(&$variables) {

  $submission = $variables['submission'];
  $submissionData = $submission->getData();

  $history = [];
  if (isset($submissionData["status_updates"]) && is_array($submissionData["status_updates"])) {
    $config = \Drupal::config('grants_handler.settings');
    $statusStrings = $config->get('statusStrings');
    $langCode = \Drupal::languageManager()->getCurrentLanguage()->getId();
    foreach (array_reverse($submissionData["status_updates"]) as $event) {
      if ($event["citizenCaseStatus"] != 'SUBMITTED') {
        $eventDate = new \DateTime($event['timeCreated']);
        $eventDate->setTimezone(new \DateTimeZone('Europe/Helsinki'));
        $translatedStatus = $statusStrings[$langCode][$event['citizenCaseStatus']];
        $history[] = $translatedStatus . ': ' . $eventDate->format('d.m.Y H:i');
      }
    }
  }

  $variables['history'] = [
    '#theme' => 'item_list',
    '#list_type' => 'ul',
    '#items' => $history,
    '#attributes' => ['class' => 'application-status-history'],
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * @throws \Exception
 */
function grants_handler_preprocess_webform_submission_events(&$variables) {

  $submission = $variables['submission'];
  $submissionData = $submission->getData();

  $events = [];
  if (isset($submissionData['events']) && is_array($submissionData['events'])) {
    foreach ($submissionData['events'] as $event) {
      $eventDate = new \DateTime($event['timeCreated']);
      $eventDate->setTimezone(new \DateTimeZone('Europe/Helsinki'));
      $events[] = [
        'date' => $eventDate->format('d.m.Y H:i'),
        'eventSource' => $event['eventSource'] ?? '',
        'eventDescription' => $event['eventDescription'] ?? '',
      ];
    }
    array_multisort(array_column($events, "date"), SORT_DESC, $events);
  }

  $table = [
    '#type' => 'table',
    '#header' => [
      'date' => t('Date'),
      'eventSource' => t('Source', [], ['context' => 'submission event']),
      'eventDescription' => t('Description'),
    ],
    '#rows' => $events,
    '#empty' => t('No events have been found.'),
  ];

  $variables['events'] = $table;
}

/**
 * Implements hook_preprocess_HOOK().
 *
 * @throws \Exception
 */
function grants_handler_preprocess_webform_submission_message_attachments(&$variables) {

  $submissionAttachments = $variables['attachments'];

  $events = [];
  if (isset($submissionAttachments) && is_array($submissionAttachments)) {
    foreach ($submissionAttachments as $attachment) {
      $events[] = [
        'fileName' => $attachment['fileName'],
        'description' => $attachment['description'],
      ];
    }
  }

  $table = [
    '#type' => 'table',
    '#rows' => $events,
  ];

  $variables['attachments_to_print'] = $table;
}

/**
 * Implements hook_entity_update().
 */
function grants_handler_webform_presave(WebformInterface $webform) {
  if (defined('PHPUNIT_COMPOSER_INSTALL') || defined('__PHPUNIT_PHAR__')) {
    // We are running tests. Just return to avoid errors.
    return;
  }
  // Set an appropriate default purge setting.
  if ($purge_setting = $webform->getSetting('purge')) {
    switch ($purge_setting) {
      // We need to make sure drafts are purged as well.
      case WebformSubmissionStorageInterface::PURGE_COMPLETED:
        $purge = WebformSubmissionStorageInterface::PURGE_ALL;
        break;

      default:
        $purge = WebformSubmissionStorageInterface::PURGE_DRAFT;
        break;
    }
  }
  else {
    $purge = WebformSubmissionStorageInterface::PURGE_DRAFT;
  }
  // Enable the draft save if not already set.
  $draft_setting = $webform->getSetting('draft');
  if ($draft_setting !== WebformInterface::DRAFT_ALL) {
    $webform->setSetting('draft', WebformInterface::DRAFT_ALL);
  }
  // Set purge status to prevent clutter in the db.
  if ($purge_setting !== WebformSubmissionStorageInterface::PURGE_ALL
    || $purge_setting !== WebformSubmissionStorageInterface::PURGE_DRAFT) {
    $webform->setSetting('purge', $purge);
  }
  // Add a purge time frame if not set.
  if (empty($webform->getSetting('purge_days'))) {
    $webform->setSetting('purge_days', 365);
  }
  // Enable the linking to wizard pages.
  if (empty($webform->getSetting('wizard_progress_link'))) {
    $webform->setSetting('wizard_progress_link', TRUE);
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_webform_submission_form(&$variables) {
  /** @var \Drupal\webform\Entity\WebformSubmission $webform_submission */
  $webform_submission = $variables["form"]["#webform_submission"] ?? NULL;

  if (!$webform_submission) {
    return;
  }

  $submissionData = $webform_submission->getData();
  $request = \Drupal::request();
  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  $variables['statusTag'] = [
    '#theme' => 'application_status_tag',
    '#langcode' => $language,
    '#applicationID' => $submissionData["application_number"],
  ];
  $date = $submissionData["form_timestamp_submitted"] ?: 'now';
  $dt = new DateTime($date, new DateTimeZone('Europe/Helsinki'));
  $variables['date'] = $dt->format('d.m.Y H:i');

  if ($route = $request->attributes->get(RouteObjectInterface::ROUTE_OBJECT)) {
    $title = \Drupal::service('title_resolver')->getTitle($request, $route);
  }
  $variables['title'] = $title ?? '';

  /** @var \Drupal\grants_handler\GrantsHandlerNavigationHelper $navigationHelper */
  $navigationHelper = \Drupal::service('grants_handler.navigation_helper');
  // Get errors for printing.
  $variables['errors'] = $navigationHelper->getAllErrors($webform_submission);
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_webform_submission_handler_details(&$variables) {

  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables['submission'];
  $submissionData = $submission->getData();

  $handlerEvents = array_filter($submissionData['events'], function ($event) {
    if ($event['eventType'] == EventsService::$eventTypes['EVENT_INFO']) {
      return TRUE;
    }
    return FALSE;
  });

  foreach ($handlerEvents as $handlerEvent) {
    $variables['handler_strings'] = explode(";", $handlerEvent['eventDescription']);
  }
  $variables['handlers'] = $handlerEvents;

}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_webform_submission_attachment_list(&$variables) {

  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables['submission'];
  $submissionData = $submission->getData();

  // Get submission events.
  $attachmentEventsHandler = EventsService::filterEvents($submissionData['events'], 'HANDLER_ATT_OK');

  $attachments = [];

  $attachmentsData = array_merge($submissionData['attachments'], $submissionData['muu_liite']);

  foreach ($attachmentsData as $att) {
    if (isset($att['fileName'])) {
      try {
        $fileUploadTime = AttachmentHandler::getAttachmentUploadTime($attachmentEventsHandler['events'], $att['fileName']);
      }
      catch (Exception $e) {
        $fileUploadTime = '';
      }
      $attachmentLine = $att['description'];
      if (!empty($fileUploadTime)) {
        $attachmentLine .= ', ' . $fileUploadTime . ': ';
      }
      $attachmentLine .= $att['fileName'];
      $attachments[] = $attachmentLine;
    }
  }

  $variables['attachments'] = [
    '#theme' => 'item_list',
    '#list_type' => 'ul',
    '#items' => $attachments,
    '#attributes' => ['class' => 'application-attachment-list'],
  ];

}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_application_list(&$variables) {
  $langCode = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $config = \Drupal::config('grants_handler.settings');
  $statusStrings = $config->get('statusStrings');
  $variables['processingHumanReadable'] = $statusStrings[$langCode]['PROCESSING'];
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_application_list_item(&$variables) {
  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables['submission'];
  $webform = $submission->getWebform();
  $submissionData = $submission->getData();

  $applicationTypes = ApplicationHandler::getApplicationTypes();

  $variables['applicationFormName'] = $applicationTypes[$submissionData["application_type"]][$language];

  $variables['applicationNumber'] = $submissionData["application_number"];

  try {
    if ($submissionData['status'] == 'DRAFT') {
      if (isset($submissionData["form_timestamp"]) && !empty($submissionData["form_timestamp"])) {

        $dt = new DateTime($submissionData["form_timestamp"], new DateTimeZone('Europe/Helsinki'));
        $variables['applicationSubmitted'] = $dt->format('d.m.Y H:i');
        $variables['applicationSubmittedSortable'] = $dt->format('Y-m-d\TH:i:s');
      }
    }
    else {
      if (isset($submissionData["form_timestamp_submitted"]) && !empty($submissionData["form_timestamp_submitted"])) {
        $dt = new DateTime($submissionData["form_timestamp_submitted"], new DateTimeZone('Europe/Helsinki'));
        $variables['applicationSubmitted'] = $dt->format('d.m.Y H:i');
        $variables['applicationSubmittedSortable'] = $dt->format('Y-m-d\TH:i:s');
      }
    }
  }
  catch (\Exception $e) {
  }

  $deleteAppUrl = Url::fromRoute('grants_handler.clear-navigations', [
    'submission_id' => $submissionData["application_number"],
  ]);

  $printAppUrl = Url::fromRoute(
    'grants_webform_print.submission_print',
    [
      'submission_id' => $submissionData['application_number'],
    ],
    [
      'attributes' => [
        'data-drupal-selector' => 'application-print-link',
        'class' => ['hds-button', 'hds-button--supplementary'],
      ],
    ]
  );

  $viewApplicationUrl = Url::fromRoute(
    'grants_handler.view_application',
    [
      'submission_id' => $variables['applicationNumber'],
    ],
    [
      'attributes' => [
        'target' => '_blank',
      ],
    ]
  );

  $editApplicationUrl = Url::fromRoute(
    'grants_handler.edit_application',
    [
      'webform' => $webform->id(),
      'webform_submission' => $submission->id(),
    ],
    [
      'attributes' => [
        'data-drupal-selector' => 'application-edit-link',
      ],
    ]
  );

  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  $variables['statusTag'] = [
    '#theme' => 'application_status_tag',
    '#langcode' => $language,
    '#applicationID' => $submissionData["application_number"],
  ];

  $applicationStatuses = ApplicationHandler::getApplicationStatuses();

  $variables['classes'] = [
    strtolower($applicationStatuses[$submissionData["status"]]),
    strtolower($submissionData["application_number"]),
  ];

  $editApplicationLinkText = Markup::create(t('Edit application'));
  $viewApplicationLinkText = Markup::create(t('View application'));

  $variables['viewApplicationLink'] = Link::fromTextAndUrl($viewApplicationLinkText, $viewApplicationUrl);
  $variables['editApplicationLink'] = Link::fromTextAndUrl($editApplicationLinkText, $editApplicationUrl);

  $variables['deleteApplicationUrl'] = $deleteAppUrl->toString();
  $variables['printApplicationUrl'] = $printAppUrl->toString();

  $thirdPartySettings = $webform->getThirdPartySettings('grants_metadata');

  $variables['errorType'] = NULL;

  $variables['hasUnread'] = FALSE;
  $variables['hasUnreadText'] = NULL;
  $unreadMsgs = [];
  if (!empty($submissionData['messages'])) {
    foreach ($submissionData['messages'] as $msg) {
      if ($msg['sentBy'] == 'Avustusten kasittelyjarjestelma' && $msg['messageStatus'] == 'UNREAD') {
        array_push($unreadMsgs, $msg);
        if ($variables['hasUnread'] == FALSE) {
          $variables['hasUnread'] = TRUE;
        }
      }
    }

    $variables['hasUnreadText'] = \Drupal::translation()
      ->formatPlural(count($unreadMsgs), '1 new message', '@count new messages');
  }

  $variables['openStartDate'] = strtotime($thirdPartySettings['applicationOpen']);
  $variables['openEndDate'] = strtotime($thirdPartySettings['applicationClose']);
  $variables['isContinuous'] = $thirdPartySettings['applicationContinuous'] != 0;
  if (!$variables['isContinuous'] && ($variables['openStartDate'] > time() || $variables['openEndDate'] < time())) {
    $variables['errorType'] = 'NOT_OPEN';
  }
  try {
    if (array_key_exists($submissionData["status"], ApplicationHandler::getApplicationStatuses())) {
      $variables['statusString'] = $submissionData['status'];
    }
    else {
      \Drupal::logger('grants_handler')
        ->error('Application status not in valid statuses: %number', [
          '%number' => $submissionData["application_number"],
        ]);
    }
  }
  catch (\Exception $e) {
    $variables['statusString'] = '';
  }

}

/**
 * Implements hook_preprocess_HOOK().
 *
 * @throws \GuzzleHttp\Exception\GuzzleException
 */
function grants_handler_preprocess_application_status_tag(&$variables): void {

  try {
    $submissionObject = ApplicationHandler::submissionObjectFromApplicationNumber($variables['applicationID']);
    $submissionData = $submissionObject->getData();
    if (array_key_exists($submissionData["status"], ApplicationHandler::getApplicationStatuses())) {
      $config = \Drupal::config('grants_handler.settings');
      $statusStrings = $config->get('statusStrings');
      if (!isset($variables['langcode'])) {
        $langCode = \Drupal::languageManager()->getCurrentLanguage()->getId();
      }
      else {
        $langCode = $variables['langcode'];
      }

      $variables['statusStringHumanReadable'] = $statusStrings[$langCode][$submissionData['status']];
      $variables['statusString'] = $submissionData['status'];
      $variables['applicationNumber'] = $submissionData['application_number'];

    }
    else {
      \Drupal::logger('grants_handler')
        ->error('Application status not in valid statuses: %appno', [
          '%appno' => $submissionData["application_number"],
        ]);
    }
  }
  catch (\Exception $e) {
    $variables['statusStringHumanReadable'] = '';
    $variables['statusString'] = '';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_grants_handler_completion(&$variables) {

  $theme_handler = \Drupal::service('theme_handler');
  $theme_path = '/' . $theme_handler->getTheme('hdbt')->getPath();
  $language = \Drupal::languageManager()->getCurrentLanguage()->getId();

  $variables['statusTag'] = [
    '#theme' => 'application_status_tag',
    '#langcode' => $language,
    '#applicationID' => $variables["submissionId"],
  ];
  $variables['ownApplicationsLink'] = twig_render_template(
    $theme_path . '/templates/navigation/link-button.html.twig',
    [
      'type' => 'primary',
      'icon' => TRUE,
      'icon_type' => 'arrow-right',
      'url' => Url::fromRoute('grants_oma_asiointi.front'),
      'label' => t('My applications'),
      'theme_hook_original' => '',
    ]);
  $variables['viewApplicationLink'] = twig_render_template(
    $theme_path . '/templates/navigation/link-button.html.twig',
    [
      'type' => 'secondary',
      'icon' => TRUE,
      'icon_type' => 'eye',
      'url' => Url::fromRoute('grants_handler.view_application', ['submission_id' => $variables["submissionId"]]),
      'label' => t('View Application'),
      'theme_hook_original' => '',
    ]);
  $variables['printApplicationLink'] = twig_render_template(
    $theme_path . '/templates/navigation/link-button.html.twig',
    [
      'type' => 'secondary',
      'icon' => TRUE,
      'icon_type' => 'printer',
      'url' => Url::fromRoute('grants_webform_print.submission_print', ['submission_id' => $variables["submissionId"]]),
      'label' => t('Print application'),
      'theme_hook_original' => '',
    ]);

  try {
    $submissionObject = $variables['submissionObject'];
    $submissionData = $submissionObject->getData();
    if (isset($submissionData['form_timestamp_submitted']) &&
      !empty($submissionData['form_timestamp_submitted'])) {
      $variables['applicationTimestamp'] = strtotime($submissionData['form_timestamp_submitted']);
    }
    else {
      $variables['applicationTimestamp'] = '';
    }
  }
  catch (\Exception $e) {
    $variables['applicationTimestamp'] = '';
  }
}

/**
 * Implements hook_preprocess().
 */
function grants_handler_preprocess_message_list_item(&$variables) {
  $currentUri = \Drupal::request()->getUri();
  $currentHost = \Drupal::request()->getSchemeAndHttpHost();
  $currentDestination = str_replace($currentHost, '', $currentUri);

  $message = $variables['message'];

  if ($message['messageStatus'] == 'UNREAD') {
    $markReadLink = Link::createFromRoute(t('Mark as read'), 'grants_handler.message_read',
      [
        'message_id' => $message['messageId'],
        'submission_id' => $message['caseId'],
      ],
      [
        'query' => [
          'destination' => $currentDestination,
        ],
        'attributes' => [
          'class' => ['hds-button', 'hds-button--primary'],
        ],
      ]);
  }
  else {
    $markReadLink = '';
  }
  $variables['sender'] = t('Oma viesti');
  if ($message['sentBy'] == 'Avustusten kasittelyjarjestelma') {
    $variables['sender'] = t('Applications Helsinki');
    $variables['markReadLink'] = $markReadLink;
  }
}

/**
 * Implements hook_preprocess().
 */
function grants_handler_preprocess_message_notification_item(&$variables) {
  $message = $variables['message'];

  $message_url = Url::fromRoute('grants_handler.view_application', [
    'submission_id' => $message['caseId'],
  ]);

  $message_link = Link::fromTextAndUrl($message['caseId'], $message_url);

  $variables['message_link'] = $message_link;
}

/**
 * Implements hook_preprocess().
 */
function grants_handler_preprocess_message_list(&$variables) {

}

/**
 * Process information box.
 *
 * @param array $variables
 *   Variables for template.
 */
function grants_handler_preprocess_html(array &$variables) {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name === 'grants_handler.edit_application') {
    $variables['attributes']['class'][] = 'hakemus-form-page';
  }
}

/**
 * Process information box.
 *
 * @param array $variables
 *   Variables for template.
 */
function grants_handler_preprocess_webform_submission_information(array &$variables) {
  /** @var \Drupal\webform\Entity\WebformSubmission $submission */
  $submission = $variables["webform_submission"];
  $submissionData = $submission->getData();

  $webform = $submission->getWebForm();
  $thirdPartySettings = $webform->getThirdPartySettings('grants_metadata');

  $printApplicationUrl = Url::fromRoute(
    'grants_webform_print.submission_print',
    [
      'submission_id' => $submissionData['application_number'],
    ],
    [
      'attributes' => [
        'data-drupal-selector' => 'application-print-link',
        'class' => ['hds-button', 'hds-button--supplementary'],
      ],
    ]
  );
  $printApplicationLinkText = [
    '#theme' => 'edit-label-with-icon',
    '#icon' => 'printer',
    '#text_label' => t('Print application'),
  ];

  $printApplicationLink = Link::fromTextAndUrl($printApplicationLinkText, $printApplicationUrl);
  $variables['printApplicationLink'] = $printApplicationLink;

  $editApplicationUrl = Url::fromRoute(
    'grants_handler.edit_application',
    [
      'webform' => $webform->id(),
      'webform_submission' => $submission->id(),
    ],
    [
      'attributes' => [
        'data-drupal-selector' => 'application-edit-link',
        'class' => ['hds-button', 'hds-button--primary'],
      ],
    ]
  );

  if (ApplicationHandler::isSubmissionEditable($submission)) {

    $editApplicationLinkText = [
      '#theme' => 'edit-label-with-icon',
      '#icon' => 'pen-line',
      '#text_label' => t('Edit application'),
    ];
    $editApplicationLink = Link::fromTextAndUrl($editApplicationLinkText, $editApplicationUrl);
    $variables['editApplicationLink'] = $editApplicationLink;
  }
  // Show copy button only if copying has not been disabled.
  if ($thirdPartySettings["disableCopying"] != 1) {
    $copyApplicationUrl = Url::fromRoute(
      'grants_handler.copy_application_modal',
      [
        'submission_id' => $submissionData['application_number'],
        'nojs' => 'ajax',
      ],
      [
        'attributes' => [
          'class' => ['use-ajax', 'hds-button', 'hds-button--supplementary'],
          'data-dialog-type' => 'modal',
          'data-dialog-options' => json_encode(CopyApplicationModalForm::getDataDialogOptions()),
          // Add this id so that we can test this form.
          'id' => 'copy-application-modal-form-link',
        ],
      ]
    );
    $copyApplicationLinkText = [
      '#theme' => 'edit-label-with-icon',
      '#icon' => 'copy',
      '#text_label' => t('Copy application'),
    ];
    $copyApplicationLink = Link::fromTextAndUrl($copyApplicationLinkText, $copyApplicationUrl);
    $variables['copyApplicationLink'] = $copyApplicationLink;
  }

  $variables['formTitle'] = $webform->label();
  $variables['printLink'] = '';
  $variables['copyLink'] = '';

  $variables['applicationNumber'] = ApplicationHandler::createApplicationNumber($submission);
  $variables['isEditable'] = ApplicationHandler::isSubmissionEditable($submission);
  $variables['isEditPage'] = 'grants_handler.edit_application' === \Drupal::routeMatch()
    ->getRouteName();

  if ($submissionData["form_timestamp_submitted"]) {
    try {
      $dt = new \DateTime($submissionData['form_timestamp_submitted'], new \DateTimeZone('Europe/Helsinki'));
      $variables['applicationSent'] = $dt->format('d.m.Y H:i');
    }
    catch (Exception $e) {
    }
  }
  else {
    // In older applications we don't have this set yet so show something.
    // We should not arrive here that often.
    $variables['applicationSent'] = 'xx.xx.xxxx';
  }

  $variables['history'] = [
    '#theme' => 'webform_submission_status_history',
    '#submission' => $submission,
  ];

  $variables['handler'] = [
    '#theme' => 'webform_submission_handler_details',
    '#submission' => $submission,
  ];

  $variables['attachments'] = [
    '#theme' => 'webform_submission_attachment_list',
    '#submission' => $submission,
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_application_copy_modal_form(&$variables) {
  // Use this if you want to edit modal form template in application copying.
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_submission_for_modal_form(&$variables) {
  // Use this if you want to edit submissin data for copying.
}

/**
 * Implements hook_user_logout().
 */
function grants_handler_user_logout(AccountInterface $account) {

  // Instantiate our event.
  $event = new UserLogoutEvent($account);

  // Get the event_dispatcher service and dispatch the event.
  $event_dispatcher = \Drupal::service('event_dispatcher');
  $event_dispatcher->dispatch($event, UserLogoutEvent::EVENT_NAME);
}

/**
 * Implements hook_ENTITY_TYPE_access().
 */
function grants_handler_node_access(EntityInterface $entity, $operation, AccountInterface $account) {
  $result = AccessResult::neutral();
  $type = $entity->bundle();
  if ($type == 'form_page') {
    if ($account->isAnonymous()) {
      $result = AccessResult::forbidden();
    }
  }

  return $result;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function grants_handler_preprocess_compensation_composite(&$variables) {
  // Empty method just to shut up log warnings.
}

/**
 * Implements hook_preprocess_form_element().
 */
function grants_handler_preprocess_form_element(&$variables) {
  if (isset($variables['element']['#attributes']['error_label']) && $variables['type'] !== 'radio') {
    $variables['errors'] = $variables['element']['#attributes']['error_label'];
  }
}

/**
 * Implements hook_preprocess_fieldset().
 */
function grants_handler_preprocess_fieldset(&$variables) {
  if (isset($variables['element']['#attributes']['error_label'])) {
    $variables['errors'] = $variables['element']['#attributes']['error_label'];
  }
}

/**
 * Implements hook_language_switch_links_alter().
 */
function grants_handler_language_switch_links_alter(array &$links) {
  $route_match = Drupal::routeMatch();
  if (!$route_match) {
    return;
  }

  $route_name = $route_match->getRouteName();

  if ($route_name === 'grants_handler.edit_application') {
    $webform_key = $route_match->getParameter('webform');
    $webform = Webform::load($webform_key);

    if (!$webform) {
      return;
    }

    // If we have translations for webform, override
    // untranslated as original hbdt doesn't take account into dynamic routes.
    $translations = array_keys($webform->getTranslationLanguages());

    foreach ($translations as $translation) {
      if ($links[$translation]) {
        $links[$translation]['#untranslated'] = FALSE;
      }
    }
  }

}

/**
 * Implements hook_cron().
 */
function grants_handler_cron() {
  $service = \Drupal::service('grants_handler.form_lock_service');
  $service->clearExpiredLocks();
}

/**
 * Checks if composite element if multi value and handles errors.
 *
 * @param array $element
 *   The element array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _grants_handler_process_multivalue_errors(&$element, $form_state) {
  $storage = $form_state->getStorage();
  $errors = $storage['errors'];

  $componentErrors = $errors[$element['#webform_key']] ?? [];

  preg_match_all("/\[([^\]]*)\]/", $element['#name'], $matches);

  $relevantErrors = NestedArray::getValue($componentErrors, $matches[1]);

  if ($relevantErrors) {
    foreach ($relevantErrors as $key => $error) {
      if (!is_array($error)) {
        continue;
      }

      $element[$key]['#attributes']['class'][] = $error['class'];
      $element[$key]['#attributes']['error_label'] = $error['label'];
    }
  }
}
